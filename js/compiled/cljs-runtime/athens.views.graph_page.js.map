{"version":3,"sources":["athens/views/graph_page.cljs"],"mappings":";AAWA,AAAA,AAAMA;AAAN,AAEE,AAAMC,AAAmB,AAAAC,AAAA,AAAA;AAAAC,AAAA,AAAAC,AAGME;AAHN,AAAA,AAAAJ,AAAAC,AAAAD,AAAAC,AAACE,AAAAA,AAAAA;;AAIpBE,AAAmB,AAAAC,AAAA,AAAA;AAAAC,AAAA,AAAAL,AAIME;AAJN,AAAA,AAAAE,AAAAC,AAAAD,AAAAC,AAACJ,AAAAA,AAAAA;;AAKpBK,AAAmB,AAACC,AAAe,AAACC,AAAIX,AAAW,AAACW,AAAIL;AACxDA,AAAmB,AAAAM,AAAA,AAAA;AAAAC,AAAA,AAAAV,AAKME;AALNS,AAKcR;AALd,AAAA,AAAAM,AAAAC,AAAAC,AAAAF,AAAAC,AAAAC,AAACV,AAAAA,AAAAA;;AAMpBK,AAAmB,AAAAM,AAAA,AAAA;AAAAC,AAAA,AAAAb,AAKME;AALNY,AAKcR;AALd,AAAA,AAAAM,AAAAC,AAAAC,AAAAF,AAAAC,AAAAC,AAACb,AAAAA,AAAAA;;AAMpBJ,AAAmB,AAACkB,AAAI,AAAAC;AAAA,AAAA,AAAAC,AAAAD;AAAA,AAAAE,AAAAD,AAAA,AAAA,AAAME;AAAN,AAAAD,AAAAD,AAAA,AAAA,AAAQG;AAAR,AAAAF,AAAAD,AAAA,AAAA,AAAUI;AAAV,AAAA,AAAA,AAAA,AAAA,AACUF,AACAC,AACAC;AACV,AAACC,AAAOnB,AAAgBG;AA1BtD,AA2BET;;AAGJ,AAAA,AAAM0B;AAAN,AAOO,AAACR,AAAI,AAAAW;AAAA,AAAA,AAAAC,AAAAD;AAAA,AAAAR,AAAAS,AAAA,AAAA,AAAMC;AAAN,AAAAV,AAAAS,AAAA,AAAA,AAAeE;AAAf,AAAA,AAAA,AAAA,AACY,AAAA,AAAA,AAAA,AAAIA,AACAC,AACAC,AAEJH;AAVjB,AAAAJ,AAAA,AAAA;AAAAC,AAAA,AAAAzB,AAIME;AAJN,AAAA,AAAAsB,AAAAC,AAAAD,AAAAC,AAACxB,AAAAA,AAAAA;;;AAaR,AAAA,AAAM+B;AAAN,AAEE;AAAA,AAAA,AAAA,AAAA","names":["athens.views.graph-page/build-nodes","all-nodes","G__61031","G__61032","cljs.core/deref","datascript.core/q","athens.db/dsdb","nodes-with-refs","G__61033","G__61034","nodes-without-refs","clojure.set.difference","cljs.core/set","G__61035","G__61036","G__61037","G__61038","G__61039","G__61040","cljs.core.map","p__61041","vec__61042","cljs.core.nth","e","t","val","cljs.core.concat","athens.views.graph-page/build-links","G__61049","G__61050","p__61045","vec__61046","node-eid","ref","athens.db/get-parents-recursively","cljs.core/first","athens.views.graph-page/graph-page"],"sourcesContent":["^:cljstyle/ignore\n(ns athens.views.graph-page\n  (:require\n    #_[\"react-force-graph\" :as rfg]\n    [athens.db :as db]\n    [athens.style :as styles]\n    [clojure.set :as set]\n    [datascript.core :as d]\n    [re-frame.core :as rf]))\n\n\n(defn build-nodes\n  []\n  (let [all-nodes          (d/q '[:find [?e ...]\n                                  :where\n                                  [?e :node/title _]]\n                                @db/dsdb)\n        nodes-with-refs    (d/q '[:find [?e ...]\n                                  :where\n                                  [?e :node/title _]\n                                  [_ :block/refs ?e]]\n                                @db/dsdb)\n        nodes-without-refs (set/difference (set all-nodes) (set nodes-with-refs))\n        nodes-with-refs    (d/q '[:find ?e ?t (count ?r)\n                                  :in $ [?e ...]\n                                  :where\n                                  [?e :node/title ?t]\n                                  [?r :block/refs ?e]]\n                                @db/dsdb nodes-with-refs)\n        nodes-without-refs (d/q '[:find ?e ?t ?c\n                                  :in $ [?e ...]\n                                  :where\n                                  [?e :node/title ?t]\n                                  [(get-else $ ?e :always-nil-value 1) ?c]]\n                                @db/dsdb nodes-without-refs)\n        all-nodes          (map (fn [[e t val]]\n                                  {\"id\"   e\n                                   \"name\" t\n                                   \"val\"  val})\n                                (concat nodes-with-refs nodes-without-refs))]\n    all-nodes))\n\n\n(defn build-links\n  []\n  (->> (d/q '[:find ?e ?r\n              :where\n              [?e :node/title ?t]\n              [?r :block/refs ?e]]\n            @db/dsdb)\n       (map (fn [[node-eid ref]]\n              {\"source\" (-> ref\n                            db/get-parents-recursively\n                            first\n                            :db/id)\n               \"target\" node-eid}))))\n\n\n(defn graph-page\n  []\n  (fn []\n    [:div \"graph page!\"]\n    #_(let [dark? @(rf/subscribe [:theme/dark])\n          nodes (build-nodes)\n          links (build-links)\n          theme (if dark? styles/THEME-DARK\n                    styles/THEME-LIGHT)]\n\n      [:> rfg/ForceGraph2D\n       {:graphData        {:nodes nodes\n                           :links links}\n        ;; example data\n        #_{:nodes [{\"id\" \"foo\", \"name\" \"name1\", \"val\" 1}\n                   {\"id\" \"bar\", \"name\" \"name2\", \"val\" 10}]\n           :links [{\"source\" \"foo\", \"target\" \"bar\"}]}\n        :width            (* 0.95 (.-innerWidth js/window))\n        :height           (* 0.95 (.-innerHeight js/window))\n        :linkColor        (fn [] (:border-color theme))\n        :nodeCanvasObject (fn [^js node ^js ctx global-scale]\n                            (let [label        (.. node -name)\n                                  val          (.. node -val)\n                                  x            (.. node -x)\n                                  y            (.. node -y)\n                                  scale-factor 4\n                                  font-size    (max 10 (-> (js/Math.sqrt val)\n                                                           (/ global-scale)\n                                                           (* scale-factor)))\n                                  text-width   (.. ctx (measureText label) -width)\n                                  radius       (-> (js/Math.sqrt val)\n                                                   (/ global-scale)\n                                                   (* scale-factor))]\n                              (set! (.-font ctx) (str font-size \"px IBM Plex Sans, Sans-Serif\"))\n                              (set! (.-fillStyle ctx) (:header-text-color theme))\n                              (.fillText ctx label\n                                         (- x (/ text-width 2))\n                                         (- y radius))\n                              (.beginPath ctx)\n                              ;; https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/arc\n                              (.arc ctx x y radius 0 (* js/Math.PI 2))\n                              (set! (.-fillStyle ctx) (:link-color theme))\n                              (.fill ctx)))}])))\n"]}